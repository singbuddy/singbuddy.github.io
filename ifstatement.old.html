<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Singing App</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="data:," />
    <meta name="apple-mobile-web-app-capable" content="yes" />
  </head>
  <body>
    <script src="js/settings.js"></script>

    <audio id="audioPlayer" src="c-major-scale.mp3"></audio>

    <script>
      var audioPlayer = document.getElementById("audioPlayer");

      function playAudio() {
        audioPlayer.play();
      }

      function pauseAudio() {
        audioPlayer.pause();
      }

      function stopAudio() {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
      }
    </script>
    <canvas
      id="newCanvas"
      style="
        background-color: rgb(59, 59, 148);
        background-image: url('blue-gradient.webp');
        background-size: cover;
        background-position: center;
      "
      width="6000"
      height="600"
      ondblclick="startPitchDetect();"
    ></canvas>

    <script>
      // Get the reference to the div element
      var myDiv = document.getElementById("newCanvas");

      // Function to update the dimensions of the div
      function updateDivSize() {
        myDiv.style.width = window.innerWidth + "px";
        myDiv.style.height = window.innerHeight + "px";
      }

      // Initial call to set the div size
      updateDivSize();

      // Event listener for window resize
      window.addEventListener("resize", updateDivSize);
    </script>

    <div></div>

    <div id="detector" class="vague">
      <div class="pitch"><span id="pitch">--</span>Hz</div>
      <div class="note"><span id="note">--</span></div>
      <canvas id="output" width="300" height="42"></canvas>
      <div id="detune">
        <span id="detune_amt">--</span><span id="flat">cents ♭</span
        ><span id="sharp">cents ♯</span>
      </div>
    </div>

    <!-- <canvas id="waveform" width="512" height="256"></canvas> -->
    <!-- <img src="assets/piano.svg" alt=""> -->

    <!-- make the buttons playable -->

    <script>
      const elements = document.querySelectorAll("path");
      let activeOscillator = null;

      elements.forEach((element) => {
        const keyName = element.getAttribute("id");
        const frequency = frequencies[keyName];

        element.addEventListener("mousedown", () => {
          if (activeOscillator) {
            activeOscillator.stop();
          }
          activeOscillator = playTone(frequency, keyName);
          element.classList.add("pressed");
        });

        element.addEventListener("mouseup", () => {
          if (activeOscillator) {
            activeOscillator.stop();
            activeOscillator = null;
          }
          // element.classList.remove('pressed');
        });

        element.addEventListener("mouseleave", () => {
          if (activeOscillator) {
            activeOscillator.stop();
            activeOscillator = null;
          }
          element.classList.remove("pressed");
        });
      });

      function playTone(frequency, keyname) {
        const context = new AudioContext();
        const oscillator = context.createOscillator();
        oscillator.type = "square";
        oscillator.frequency.setValueAtTime(frequency, context.currentTime);
        console.log(frequency, keyname);
        oscillator.connect(context.destination);
        oscillator.start();
        return oscillator;
      }

      ////////////////
      /////
      // its possible to resize the canvas with this
      const canvas = document.getElementById("newCanvas");
      let isDragging = false;
      let initialHeight = canvas.clientHeight;
      // let maxHeight = initialHeight;

      canvas.addEventListener("mousedown", startDrag);
      canvas.addEventListener("mousemove", adjustMaxHeight);
      canvas.addEventListener("mouseup", stopDrag);

      function startDrag() {
        isDragging = true;
        initialHeight = canvas.clientHeight;
        console.log(1);
      }

      function adjustMaxHeight(event) {
        if (isDragging) {
          const deltaY = event.clientY - canvas.getBoundingClientRect().top;
          maxHeight = Math.max(initialHeight + deltaY, 0);
          canvas.style.maxHeight = `${maxHeight}px`;
        }
      }

      function stopDrag() {
        isDragging = false;
      }
    </script>
  </body>
</html>
